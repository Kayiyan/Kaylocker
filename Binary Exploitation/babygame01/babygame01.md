# Overview #
- Points : 100
- Tags : `game`

# Description #
Get the flag and reach the exit.
Welcome to BabyGame! Navigate around the map and see what you can find! The game is available to download here. There is no source available, so you'll have to figure your way around the map.

# Hints : #
* Use 'w','a','s','d' to move around.
* There may be secret commands to make your life easy.

# Solutions #

Download file `game` của bài cung cấp hoặc mình đã để nó ở đây : [game](https://github.com/Kayiyan/picoCTF-2023-Writeup/blob/d1f2beaecbd8481ed6eb2e032739a586e54f473c/Binary%20Exploitation/babygame01/game)

file nhị phân nên sẽ cần một số cung cụ để dịch ngược file , ở đây mình sẽ dùng `IDA` và : [Ghidra](https://ghidra-sre.org) hoặc mở `Ghidra` trên máy ảo `Linux` .

Đầu tiên hãy kiểm tra bảo mật của file `game` này bằng [pwntools](https://python3-pwntools.readthedocs.io/en/latest/index.html) với câu lệnh `checksec` :

![image](https://user-images.githubusercontent.com/126185640/230261075-9369b553-29bf-4b9d-9ae9-5975e5e7d332.png)

Mở file `game`với `IDA` :

![image](https://user-images.githubusercontent.com/126185640/230261349-667192d6-020f-4777-b36d-7ff003846ec0.png)

giao diện ban đầu khi mở : 

![image](https://user-images.githubusercontent.com/126185640/230261769-11af4642-6715-4c1c-959e-227ba5c0e8de.png)

Nhấn `F5` sẽ giúp chuyển về pseudocode (C) có thể dễ nhìn nhận hơn : 

![image](https://user-images.githubusercontent.com/126185640/230262273-1c6a57b6-2c81-44a1-8372-a854fb5d8b1d.png)

Tìm kiếm một chút thì hàm `win()` sẽ gọi file `flag.txt` có thể chứa flag thực tế trên server :

![image](https://user-images.githubusercontent.com/126185640/230262426-4e7f7691-8108-4f9c-8b06-8bd48670948c.png)

Đoạn code cần chú ý : 

![image](https://user-images.githubusercontent.com/126185640/230264157-8159413f-067f-4861-b16c-f945fa832efa.png)

Để chiến thắng trò chơi thì biến `v6` cần khác 0 :

cụ thể sẽ nhìn rõ hơn nếu dùng `Ghidra` :

![image](https://user-images.githubusercontent.com/126185640/230265325-d5ae07be-df50-4be5-b7b0-4f8b1ff4b5b2.png)

để ý vào hàm `move_player` : ngoài 4 phím di chuyển sẽ có 2 phím khác cần chú ý :

![image](https://user-images.githubusercontent.com/126185640/230266011-e82af263-dfc4-431c-96de-8632c7122e25.png)

![image](https://user-images.githubusercontent.com/126185640/230265908-bdd78bb3-c6bf-46ca-a796-5a47757a7c67.png)

Ở đây :

* `l` -> dùng gán một giá trị vào `player_tile` từ `getchar()`

* `p` -> thắng trò chơi ( tự di chuyển đến đích và luôn thắng ).

chú ý vào hàm `int_map` :

![image](https://user-images.githubusercontent.com/126185640/230267892-7d7234b3-d742-48cf-acff-d21053a49fd5.png)

Có thể chuyển các số ghi vị trí sang `decimal` để có thể thuận tiện quan sát.Ở đây :

Nếu `local_10` bằng `29` và `local_c` bằng `89` thì giá trị tại vị trí `param_1 + 2699` sẽ được gán bằng `88`. Nếu `local_10` bằng giá trị đầu tiên của `param_2` và `local_c` bằng giá trị thứ hai của` param_2` thì giá trị tại vị trí `local_c + param_1 + local_10 * 90` sẽ được gán bằng `player_tile`. Trong các trường hợp còn lại, giá trị tại vị trí `local_c + param_1 + local_10 * 90` sẽ được gán bằng `46`.

![image](https://user-images.githubusercontent.com/126185640/230268450-07d7466b-8aba-4f4a-a127-a6d0fb292fd2.png)


![image](https://user-images.githubusercontent.com/126185640/230270129-0f3d0fad-a327-4808-ad7d-529e9a4b1e96.png)

hàm `init_map()` xác nhận  thứ tự tọa độ vị trí của người chơi, như đã trình bày chi tiết ở trên. Nó cũng hiển thị vị trí thoát là điều kiện thắng trò chơi, đó là người chơi phải đạt được { 29, 89 }

![image](https://user-images.githubusercontent.com/126185640/230270167-56fd4c8f-2c34-4f7b-84b2-d4ed6505a9d1.png)
![image](https://user-images.githubusercontent.com/126185640/230270278-6377e384-aa73-42dd-b06e-abe4225148f1.png)

chạy file `game` trên local để kiểm chứng , từ tọa độ {29,89} di chuyển ra ngoài map sẽ gặp lỗi như hình 1 , cụ thể : 

Lỗi phân đoạn là một loại lỗi cụ thể do truy cập bộ nhớ “không thuộc về bạn”. Đó là một cơ chế trợ giúp giúp bạn không làm hỏng bộ nhớ và gây ra các lỗi bộ nhớ khó gỡ lỗi. Bất cứ khi nào bạn gặp lỗi phân đoạn, bạn biết rằng mình đang làm sai điều gì đó với bộ nhớ – truy cập vào một biến đã được giải phóng, ghi vào phần chỉ đọc của bộ nhớ, v.v. Lỗi phân đoạn về cơ bản giống nhau ở hầu hết các ngôn ngữ khiến bạn gặp rắc rối với quản lý bộ nhớ, không có sự khác biệt chính giữa segfaults trong C và C++.

Vì vậy khi chuyển đến `flag : 64` bằng phím `a` cần sử dụng `p` để giải quyết sẽ được như hình 2.

vị trí {0,-4} có được nhờ dòng :<underflows hàm của dòng này và viết vị trí người chơi trên `local_aa4`-> điều kiện cho `local_aa4` khác 0>

![image](https://user-images.githubusercontent.com/126185640/230271733-0754c26f-38d6-47be-bc7a-0f0750b3918b.png)

Kết nối lên server để lấy flag thực tế :

![image](https://user-images.githubusercontent.com/126185640/230272307-05240957-c4ce-40a9-9053-9a457c0a5031.png)

flag thu được : `picoCTF{gamer_m0d3_enabled_3aa88304}`


